version: 2
jobs:
  build-gcc-debug:
    docker:
      - image: emgre/circleci-gcc:0.0.1
    steps:
      - checkout
      - run:
          name: Initialize submodules
          command: git submodule update --init
      - run:
          name: Configure
          command: cmake -DCMAKE_BUILD_TYPE=Debug -DCMAKE_C_FLAGS="-Wall" -DCMAKE_CXX_FLAGS="-Wall" ..
          working_directory: build
      - run:
          name: Build
          command: cmake --build . -- -j2
          working_directory: build
      - run:
          name: Test
          command: ctest -VV .
          working_directory: build
  build-gcc-release:
    docker:
      - image: emgre/circleci-gcc:0.0.1
    steps:
      - checkout
      - run:
          name: Initialize submodules
          command: git submodule update --init
      - run:
          name: Configure
          command: cmake -DCMAKE_BUILD_TYPE=Release -DCMAKE_C_FLAGS="-Wall" -DCMAKE_CXX_FLAGS="-Wall" ..
          working_directory: build
      - run:
          name: Build
          command: cmake --build . -- -j2
          working_directory: build
      - run:
          name: Test
          command: ctest -VV .
          working_directory: build
  build-clang-debug:
    docker:
      - image: emgre/circleci-clang:0.0.1
    steps:
      - checkout
      - run:
          name: Initialize submodules
          command: git submodule update --init
      - run:
          name: Configure
          command: cmake -DCMAKE_BUILD_TYPE=Debug -DCMAKE_C_FLAGS="-Wall" -DCMAKE_CXX_FLAGS="-Wall" ..
          working_directory: build
      - run:
          name: Build
          command: cmake --build . -- -j2
          working_directory: build
      - run:
          name: Test
          command: ctest -VV .
          working_directory: build
  build-clang-release:
    docker:
      - image: emgre/circleci-clang:0.0.1
    steps:
      - checkout
      - run:
          name: Initialize submodules
          command: git submodule update --init
      - run:
          name: Configure
          command: cmake -DCMAKE_BUILD_TYPE=Release -DCMAKE_C_FLAGS="-Wall" -DCMAKE_CXX_FLAGS="-Wall" ..
          working_directory: build
      - run:
          name: Build
          command: cmake --build . -- -j2
          working_directory: build
      - run:
          name: Test
          command: ctest -VV .
          working_directory: build
  build-doc:
      docker:
        - image: emgre/circleci-doxygen:0.0.1
      steps:
        - checkout
        - run:
            name: Initialize m.css submodule
            command: git submodule update --init deps/m.css
        - run:
            name: Create build/doc directory
            command: mkdir -p build/doc
        - run:
            name: Build documentation
            command: python3 deps/m.css/doxygen/dox2html5.py Doxyfile-mcss
        - store_artifacts:
             path: build/doc
             destination: doc
workflows:
  version: 2
  build_and_test:
    jobs:
      #- build-gcc-debug
      #- build-gcc-release
      #- build-clang-debug
      #- build-clang-release
      - build-doc
          #requires:
          #  - build-gcc-debug
          #  - build-gcc-release
          #  - build-clang-debug
          #  - build-clang-release
